<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Functions</title>
<!--link rel="shortcut icon" href="../favicon.ico"-->
<link rel="stylesheet"
	href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
<link rel="stylesheet" href="function.css">
<link rel="stylesheet" href="jquery-ui-1.11.3.custom/jquery-ui.min.css">
<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="jquery-ui-1.11.3.custom/jquery-ui.min.js"></script>
<script
	src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script src="Chart.js/Chart.js"></script>

<script>
  var lineChart = null;
  function getUrlParam(param) {
    if (window.document.URL.indexOf("?") > 0) {
      var params = window.document.URL.substring(window.document.URL.indexOf("?") + 1).split("&");
      for (var i = 0; i < params.length; i++) {
        if (params[i].indexOf("=") > 0) {
          var spl = params[i].split("=");
          if (spl[0] === param) {
            return spl[1];
          }
        }
      }
    }
    return "";
  }

  function makeChart(time) {
    var uid = getUrlParam("uid");
    var fUid = getUrlParam("function");
    var values = [];
    if (uid !== "" && fUid !== "") {
      $("#functionUid").text(fUid);
      $.ajax("rest/devices/" + uid + "/" + fUid + "/day/" + time).done(function(data) {
        //alert("success: " + data);
        var values = [];
        var i = 0;
        var keys = Object.keys(data).sort();
        for ( var key in keys) {
          var v = data[keys[key]];
          if (v) {
            v = v.toFixed(2);
          }
          values[i++] = v;
        }
        var labels = createLabels(keys, "day");
        var data = {
          labels : labels,
          datasets : [ {
            label : "values",
            fillColor : "rgba(220,220,220,0.2)",
            strokeColor : "rgba(220,220,220,1)",
            pointColor : "rgba(220,220,220,1)",
            pointStrokeColor : "#fff",
            pointHighlightFill : "#fff",
            pointHighlightStroke : "rgba(220,220,220,1)",
            data : values
          } ]
        };
        var ctx = $("#myChart").get(0).getContext("2d");
        if (lineChart) {
          lineChart.destroy();
        }
        var myNewChart = new Chart(ctx);
        lineChart = myNewChart.Line(data, {
          pointHitDetectionRadius : 0
        });
      }).fail(function() {
        alert("error");
      });
    }
  }

  function createLabels(times, interval) {
    var labels = [];
    for ( var time in times) {
      var d = new Date(Number(times[time]));
      if (interval === "day") {
        labels[time] = d.getHours();
      } else if (interval === "week") {
        labels[time] = d.getDay();
      }
    }
    return labels;
  }

  $(function() {
    Chart.defaults.global.responsive = true;
    var timestamp = new Date().setHours(0, 0, 0, 0);
    makeChart(timestamp);
    $("#datepicker").datepicker({
      autoSize : true,
      dateFormat : "yy-mm-dd",
      onSelect : function() {
        var time = $(this).datepicker("getDate").getTime();
        makeChart(time);
      }
    });
    $("#datepicker").datepicker("setDate", "0");
  });
</script>
</head>
<body>
	<div data-role="page" data-theme="b" id="demo-page" class="my-page">

		<div data-role="header">
			<h1 id="functionUid">Function uid</h1>
			<a href="./" data-shadow="false" data-iconshadow="false"
				data-icon="carat-l" data-rel="back" data-ajax="false">Back</a>
		</div>
		<!-- /header -->

		<div role="main" class="ui-content">

			<div>
				<canvas id="myChart"></canvas>
			</div>
			<input id="datepicker" type="text" data-role="date">

		</div>
		<!-- /content -->

	</div>
	<!-- /page -->

</body>
</html>